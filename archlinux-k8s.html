<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>archlinux-k8s</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="archlinux-k8s">archlinux-k8s</h1>
<h2 id="kmaster--knode-install-guid">kmaster &amp; knode install guid</h2>
<h3 id="snap">snap</h3>
<pre><code>pacman -Sy base-devel
git clone https://aur.archlinux.org/snapd.git
cd snapd
makepkg -si
sudo systemctl enable --now snapd.socket
sudo ln -s /var/lib/snapd/snap /snap
reboot
</code></pre>
<h3 id="etcd">etcd</h3>
<pre><code>snap install etcd 
</code></pre>
<h3 id="tools-kits">tools-kits</h3>
<pre><code>pacman -Sy kubernetes-control-plane
systemctl enable kubelet.service
pacman -Sy kubeadm kubectl
</code></pre>
<h3 id="crio">crio</h3>
<pre><code>pacman -Sy cri-o
systemctl enable crio
</code></pre>
<h3 id="cni">cni</h3>
<pre><code>pacman -Sy cni-plugins
</code></pre>
<h2 id="configure">configure</h2>
<h3 id="swapoff">swapoff</h3>
<pre><code>swapoff -a
</code></pre>
<h3 id="let-iptables-see-bridged-traffic">let iptables see bridged traffic</h3>
<pre><code>$ cat &gt; kubernetes.conf &lt;&lt;EOF

net.bridge.bridge-nf-call-iptables=1

net.bridge.bridge-nf-call-ip6tables=1

net.ipv4.ip_forward=1

vm.swappiness=0

vm.overcommit_memory=1

vm.panic_on_oom=0

EOF

$ sudo cp kubernetes.conf  /etc/sysctl.d/kubernetes.conf

$ sudo sysctl -p /etc/sysctl.d/kubernetes.conf
$ sudo modprobe br_netfilter
</code></pre>
<h2 id="kmaster">kmaster</h2>
<pre><code>sudo kubeadm init --pod-network-cidr='10.244.0.0/16'  --cri-socket='/var/run/crio/crio.sock'  --v=5
</code></pre>
<h3 id="configs">configs</h3>
<pre><code>mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
export KUBECONFIG=/etc/kubernetes/admin.conf
</code></pre>
<h3 id="flannel-net-work">flannel net work</h3>
<pre><code>kubectl apply -f https://github.com/coreos/flannel/raw/master/Documentation/kube-flannel.yml
</code></pre>
<p>here i suffer some problem that kmaster is not ready<br>
and there’s error not found cni plugin<br>
just move it from <strong>opt/cni/bin/flannel</strong></p>
<h2 id="knode">knode</h2>
<p>kubeadm join …</p>
<h2 id="others">others</h2>
<ol>
<li>dns to pods</li>
</ol>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-dns
  namespace: kube-system
data:
  upstreamNameservers: |
    ["8.8.8.8"]
</code></pre>
<pre><code>kubectl create -f configmap.yml
kubectl -n kube-system rollout restart deployment coredns
</code></pre>
<ol start="2">
<li>examples</li>
</ol>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx-container
        image: docker.io/nginx
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
    nodePort: 30000
  type: NodePort

</code></pre>
<p>kubectl apply -f nginx.yaml<br>
kubectl get all -A<br>
http://[nodeaddress]:30000 to verify</p>
</div>
</body>

</html>
